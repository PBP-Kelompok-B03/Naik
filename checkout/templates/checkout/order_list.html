{% extends 'base.html' %}

{% block meta %}
<title>Order List | Naik Store</title>
{% endblock meta %}

{% block content %}
<div class="container mx-auto mt-24 bg-white rounded-xl shadow-lg p-8 max-w-6xl">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Daftar Pesanan Saya</h1>

  {% if orders %}
  <div class="overflow-x-auto">
    <table class="w-full border-collapse rounded-lg overflow-hidden">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="py-3 px-4 text-left">ID</th>
          <th class="py-3 px-4 text-left">Produk</th>
          <th class="py-3 px-4 text-left">Metode Pembayaran</th>
          <th class="py-3 px-4 text-left">Pengiriman</th>
          <th class="py-3 px-4 text-left">Asuransi</th>
          <th class="py-3 px-4 text-left">Total</th>
          <th class="py-3 px-4 text-left">Status</th>
          <th class="py-3 px-4 text-left">Tanggal</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for order in orders %}
        <tr class="hover:bg-gray-50 transition">
          <td class="py-3 px-4 font-semibold">#{{ order.id }}</td>
          <td class="py-3 px-4">
            {% for item in order.items.all %}
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
              <strong>
                <a href="{% url 'main:show_product' item.product.id %}" class="text-blue-700 hover:underline">
                  {{ item.product.title }}
                </a>
              </strong>
              <p class="text-sm text-gray-600">
                Jumlah: {{ item.quantity }} | Harga: Rp{{ item.price|floatformat:0 }}
              </p>

              {% if order.note %}
              <p class="text-xs text-gray-500 mt-1">Catatan: {{ order.note }}</p>
              {% endif %}

              <!-- Komentar -->
              <div class="mt-2 space-y-2">
                {% for c in item.comments.all %}
                <div class="bg-white border rounded-lg p-3 shadow-sm">
                  <div class="flex justify-between text-sm text-gray-600">
                    <span><strong>{{ c.author.username }}</strong>{% if c.rating %} · Rating: {{ c.rating }}/5{% endif %}</span>
                    <span>{{ c.created_at|date:"d M Y, H:i" }}</span>
                  </div>
                  <p class="text-gray-800 mt-1">{{ c.content }}</p>

                  {% for r in c.replies.all %}
                  <div class="ml-4 mt-2 p-2 bg-indigo-50 rounded-md text-sm">
                    <div class="font-semibold">{{ r.author.username }} (penjual)</div>
                    <div>{{ r.content }}</div>
                    <div class="text-gray-500 text-xs mt-1">{{ r.created_at|date:"d M Y, H:i" }}</div>
                  </div>
                  {% endfor %}
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm">Belum ada komentar untuk item ini.</p>
                {% endfor %}
              </div>

              {% if order.status in 'COMPLETED PAID' and request.user == order.user %}
              <form class="mt-3 space-y-2" action="{% url 'comments:create_comment' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="order_item_id" value="{{ item.id }}">
                <textarea name="content" placeholder="Tulis komentar..." class="w-full border rounded-lg p-2 text-sm"></textarea>
                <div class="flex items-center gap-2">
                  <input type="number" name="rating" min="1" max="5" placeholder="Rating" class="border rounded-lg px-2 py-1 w-16">
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm">Kirim</button>
                </div>
              </form>
              {% endif %}

              {% with product=item.product %}
              {% if request.user == product.user %}
                {% for c in item.comments.all %}
                <form action="{% url 'comments:reply_comment' c.id %}" method="post" class="mt-2 flex gap-2">
                  {% csrf_token %}
                  <textarea name="content" placeholder="Balas komentar..." class="flex-1 border rounded-lg p-2 text-sm"></textarea>
                  <button type="submit" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">Balas</button>
                </form>
                {% endfor %}
              {% endif %}
              {% endwith %}
            </div>
            {% endfor %}
          </td>
          <td class="py-3 px-4">{{ order.get_payment_method_display }}</td>
          <td class="py-3 px-4">{{ order.get_shipping_type_display }}</td>
          <td class="py-3 px-4">{{ order.insurance|yesno:"Ya,Tidak" }}</td>
          <td class="py-3 px-4 font-semibold">Rp{{ order.total_price|floatformat:0 }}</td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 rounded-md text-sm font-semibold
              {% if order.status == 'PAID' %}bg-green-100 text-green-700
              {% elif order.status == 'PENDING' %}bg-yellow-100 text-yellow-700
              {% elif order.status == 'SHIPPED' %}bg-blue-100 text-blue-700
              {% elif order.status == 'COMPLETED' %}bg-emerald-100 text-emerald-700
              {% else %}bg-red-100 text-red-700{% endif %}">
              {{ order.status }}
            </span>
          </td>
          <td class="py-3 px-4 text-sm text-gray-500">{{ order.created_at|date:"d M Y, H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-center text-gray-500 py-8">Belum ada pesanan yang dibuat.</p>
  {% endif %}

  <div class="text-center mt-6">
    <a href="{% url 'main:show_main' %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
      ← Kembali ke Beranda
    </a>
  </div>
</div>
{% endblock content %}