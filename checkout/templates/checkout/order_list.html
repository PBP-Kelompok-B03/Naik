<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Daftar Pesanan Saya</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 1200px;
            margin: 50px auto;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 10px;
        }
        thead {
            background-color: #2563eb;
            color: white;
        }
        th, td {
            text-align: left;
            padding: 12px 16px;
            vertical-align: top;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tbody tr:hover {
            background-color: #e5e7eb;
        }
        .status {
            font-weight: bold;
            padding: 6px 10px;
            border-radius: 6px;
            text-align: center;
            display: inline-block;
        }
        .status.PAID {
            background-color: #dcfce7;
            color: #166534;
        }
        .status.PENDING {
            background-color: #fef9c3;
            color: #854d0e;
        }
        .status.SHIPPED {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status.COMPLETED {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status.CANCELLED {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .no-orders {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
        }
        .back-btn {
            display: inline-block;
            margin-top: 20px;
            background-color: #2563eb;
            color: white;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 6px;
        }
        .back-btn:hover {
            background-color: #1e40af;
        }

        /* Comments styling */
        .item-block {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 0 rgba(0,0,0,0.03);
        }
        .comments {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e5e7eb;
        }
        .comment {
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .comment .meta {
            font-size: 0.85em;
            color: #374151;
            margin-bottom: 6px;
        }
        .comment .content {
            color: #111827;
            white-space: pre-wrap;
        }
        .reply {
            margin-left: 20px;
            margin-top: 6px;
            padding: 8px;
            background: #eef2ff;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .comment-form, .reply-form {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .comment-form textarea, .reply-form textarea {
            flex: 1 1 auto;
            min-height: 60px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 8px 10px;
            font-family: inherit;
            resize: vertical;
        }
        .comment-form input[type="number"] {
            width: 72px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover { background-color: #1e40af; }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #111827;
            border: 1px solid #e5e7eb;
        }
        .small-note {
            font-size: 0.85em;
            color: #6b7280;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Daftar Pesanan Saya</h1>

    {% if orders %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Produk</th>
                <th>Metode Pembayaran</th>
                <th>Pengiriman</th>
                <th>Asuransi</th>
                <th>Total</th>
                <th>Status</th>
                <th>Tanggal</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td style="width:6%;">#{{ order.id }}</td>
                <td style="width:40%;">
                    {% for item in order.items.all %}
                    <div class="item-block">
                        <strong><a href="{% url 'main:show_product' item.product.id %}">{{ item.product.title }}</a></strong>
                        <div class="small-note">Jumlah: {{ item.quantity }}. Harga per item: Rp{{ item.price|floatformat:0 }}</div>

                        {% if order.note %}
                        <div style="font-size: 0.85em; color: #6b7280; margin-top:6px;">Catatan: {{ order.note }}</div>
                        {% endif %}

                        <!-- tampilkan komentar untuk order_item ini -->
                        <div class="comments">
                            {% for c in item.comments.all %}
                            <div class="comment">
                                <div class="meta">
                                    <strong>{{ c.author.username }}</strong>
                                    {% if c.rating %} &middot; Rating: {{ c.rating }}/5{% endif %}
                                    <span style="float:right; font-size:0.8em; color:#6b7280;">{{ c.created_at|date:"d M Y, H:i" }}</span>
                                </div>
                                <div class="content">{{ c.content }}</div>

                                {% for r in c.replies.all %}
                                <div class="reply">
                                    <div style="font-weight:600;">{{ r.author.username }} (penjual)</div>
                                    <div>{{ r.content }}</div>
                                    <div style="font-size:0.8em; color:#6b7280;">{{ r.created_at|date:"d M Y, H:i" }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% empty %}
                                <div class="small-note">Belum ada komentar untuk item ini.</div>
                            {% endfor %}
                        </div>

                        <!-- FORM Tambah komentar (hanya jika user pemilik order && order.status sesuai) -->
                        {% if order.status == 'COMPLETED' or order.status == 'PAID' and request.user.is_authenticated and order.user == request.user %}
                            {% with existing_comment=item.comments.first %}
                                {# --- KOMENTAR: UPDATE / CREATE BLOCK --- #}
                                {% if existing_comment and existing_comment.author == request.user %}
                                    <!-- FORM untuk UPDATE -->
                                    <form class="comment-form" action="{% url 'comments:edit_comment' existing_comment.id %}" method="post" style="display:flex; flex-direction:column; gap:10px;">
                                        {% csrf_token %}
                                        <!-- textarea di atas -->
                                        <textarea name="content" placeholder="Tulis komentar/ulasan tentang produk ini..." 
                                                style="width:94%; min-height:90px; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-family:inherit;">{{ existing_comment.content }}</textarea>

                                        <!-- baris bawah: rating | Update | Hapus (sama besar) -->
                                        <div style="display:flex; gap:8px;">
                                            <!-- rating (sama ukuran) -->
                                            <input type="number" name="rating" min="1" max="5" value="{{ existing_comment.rating }}"
                                                style="flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db; text-align:center; font-size:1rem;">

                                            <!-- update button (submit) -->
                                            <button type="submit" class="btn" 
                                                    style="flex:1; background-color:#2563eb; color:white; border:none; padding:10px; border-radius:8px; font-weight:600;">
                                                Update
                                            </button>

                                            <!-- delete button (JS) -->
                                            <!-- <button type="button" onclick="deleteComment({{ existing_comment.id }}, '{% url 'comments:delete_comment' existing_comment.id %}')" 
                                                    style="flex:1; background-color:#ef4444; color:white; border:none; padding:10px; border-radius:8px; font-weight:600;">
                                                Hapus
                                            </button> -->
                                            <a href="{% url 'comments:delete_comment' existing_comment.id %}" style="flex:1; background-color:#ef4444; color:white; border:none; padding:10px; border-radius:8px; font-weight:600;"
                                            onclick="return confirm('Apakah kamu yakin ingin menghapus komentar ini?');">
                                            Hapus
                                            </a>
                                        </div>
                                    </form>

                                {% else %}
                                    <!-- FORM untuk CREATE (kosong) -->
                                    <form class="comment-form" action="{% url 'comments:create_comment' %}" method="post" style="display:flex; flex-direction:column; gap:10px;">
                                        {% csrf_token %}
                                        <input type="hidden" name="order_item_id" value="{{ item.id }}">

                                        <!-- textarea di atas -->
                                        <textarea name="content" placeholder="Tulis komentar/ulasan tentang produk ini..." 
                                                style="width:100%; min-height:90px; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-family:inherit;"></textarea>

                                        <!-- baris bawah: rating | Kirim | spacer (agar lebar sama) -->
                                        <div style="display:flex; gap:8px;">
                                            <input type="number" name="rating" min="1" max="5" placeholder="Rating"
                                                style="flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db; text-align:center; font-size:1rem;">

                                            <button type="submit" class="btn" 
                                                    style="flex:1; background-color:#2563eb; color:white; border:none; padding:10px; border-radius:8px; font-weight:600;">
                                                Kirim
                                            </button>

                                            <!-- spacer untuk menjaga layout agar konsisten; bisa dihapus jika tidak diinginkan -->
                                            <div style="flex:1;"></div>
                                        </div>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% endif %}


                        <!-- FORM Balasan (hanya tampil jika current user adalah seller/owner produk) -->
                        {% with product=item.product %}
                            {% if request.user.is_authenticated and product.user == request.user %}
                                <!-- tampilkan form reply untuk tiap komentar -->
                                {% for c in item.comments.all %}
                                    <form class="reply-form" action="{% url 'comments:reply_comment' c.id %}" method="post" style="margin-top:6px;">
                                        {% csrf_token %}
                                        <textarea name="content" placeholder="Balas komentar ini..."></textarea>
                                        <button class="btn btn-secondary" type="submit">Balas</button>
                                    </form>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                    </div>
                    {% endfor %}
                </td>
                <td>{{ order.get_payment_method_display }}</td>
                <td>{{ order.get_shipping_type_display }}</td>
                <td>{{ order.insurance|yesno:"Ya,Tidak" }}</td>
                <td>Rp{{ order.total_price|floatformat:0 }}</td>
                <td><span class="status {{ order.status }}">{{ order.status }}</span></td>
                <td>{{ order.created_at|date:"d M Y, H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <div class="no-orders">Belum ada pesanan yang dibuat.</div>
    {% endif %}

    <a href="{% url 'main:show_main' %}" class="back-btn">‚Üê Kembali ke Beranda</a>
</div>
</body>
</html>