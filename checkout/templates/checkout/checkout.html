{% extends 'base.html' %}

{% block meta %}
<title>Checkout | Naik Store</title>
{% endblock meta %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-900 py-10">
  <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-md p-8 transition transform hover:scale-[1.01]">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-extrabold tracking-tight text-white uppercase">Checkout</h1>
      <p class="text-gray-400 text-sm mt-1">Selesaikan pesananmu dengan cepat & aman</p>
      <div class="mt-4 w-20 h-1 bg-white mx-auto rounded"></div>
    </div>

    <!-- Form -->
    <form id="checkoutForm" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <input type="hidden" name="quantity" value="{{ quantity }}">

      <!-- Product Info -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Nama Produk</label>
        <input type="text" value="{{ product.title }}" readonly
               class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-white">
      </div>

      <div>
        <label class="font-semibold text-sm text-gray-300">Jumlah</label>
        <input type="number" value="{{ quantity }}" readonly
               class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-white">
      </div>

      <!-- Address -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Alamat Pengiriman</label>
        <textarea name="address" placeholder="Masukkan alamat lengkap" required
                  class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white"></textarea>
      </div>

      <!-- Payment Method -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Metode Pembayaran</label>
        <select name="payment_method"
                class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-white">
          <option value="COD">Cash on Delivery</option>
          <option value="TRANSFER">Transfer Bank</option>
          <option value="EWALLET" selected>E-Wallet</option>
        </select>
      </div>

      <!-- Shipping -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Jenis Pengiriman</label>
        <select name="shipping_type" id="shippingType"
                class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-white">
          <option value="BIASA">Biasa (Gratis)</option>
          <option value="CEPAT">Cepat (+Rp10.000)</option>
          <option value="SAMEDAY">Same Day (+Rp20.000)</option>
        </select>
      </div>

      <!-- Insurance -->
      <div class="flex justify-between items-center border border-gray-600 rounded-lg px-4 py-3 bg-gray-700 hover:bg-gray-600 transition">
        <span class="text-sm text-gray-200 font-medium">Tambahkan Asuransi Barang (+Rp5.000)</span>
        <input type="checkbox" id="insurance" name="insurance" class="w-5 h-5 accent-white">
      </div>

      <!-- Notes -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Catatan Tambahan</label>
        <textarea name="note" placeholder="Contoh: tolong bungkus rapi"
                  class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white"></textarea>
      </div>

      <!-- Total -->
      <div>
        <label class="font-semibold text-sm text-gray-300">Total Harga</label>
        <input type="text" name="total_price" id="totalInput" 
               value="Rp{{ total_price|floatformat:0 }}" readonly
               class="border-gray-600 mt-1 rounded-lg px-3 py-2 w-full bg-gray-700 text-white font-semibold text-left">
      </div>

      <div id="priceDisplay" class="text-right text-lg text-white font-bold mt-2">
        Total: Rp{{ total_price|floatformat:0 }}
      </div>

      <!-- Submit -->
      <button type="submit"
              class="w-full mt-6 bg-white hover:bg-gray-300 text-black py-3 rounded-xl font-bold tracking-wide uppercase transition transform hover:-translate-y-1 hover:shadow-lg">
        Bayar Sekarang
      </button>
    </form>
  </div>
</div>

<!-- Script -->
<script>
  const baseTotal = parseFloat("{{ total_price }}");
  const insuranceCheckbox = document.getElementById("insurance");
  const shippingSelect = document.getElementById("shippingType");
  const totalInput = document.getElementById("totalInput");
  const totalDisplay = document.getElementById("priceDisplay");

  function formatRupiah(num) {
    return "Rp" + num.toLocaleString("id-ID");
  }

  function updateTotal() {
    let finalTotal = baseTotal;
    const shipping = shippingSelect.value;
    if (shipping === "CEPAT") finalTotal += 10000;
    if (shipping === "SAMEDAY") finalTotal += 20000;
    if (insuranceCheckbox.checked) finalTotal += 5000;

    totalInput.value = formatRupiah(finalTotal);
    totalDisplay.textContent = `Total: ${formatRupiah(finalTotal)}`;
  }

  insuranceCheckbox.addEventListener("change", updateTotal);
  shippingSelect.addEventListener("change", updateTotal);

  const form = document.getElementById("checkoutForm");
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch("", {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === "success") {
        window.location.href = `/checkout/success/`;
      } else {
        alert(data.message || "Checkout gagal!");
      }
    })
    .catch(err => console.error("Error:", err));
  });
</script>
{% endblock content %}
