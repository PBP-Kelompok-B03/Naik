{% extends 'base.html' %}

{% block meta %}
<title>Checkout | Naik Store</title>
{% endblock meta %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-50">
  <div class="card bg-white p-8 rounded-xl shadow-lg w-[400px]">
    <h1 class="text-center text-2xl font-bold text-gray-800 mb-4">Checkout</h1>

    <form id="checkoutForm">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="quantity" value="{{ quantity }}">

        <label class="font-semibold">Nama Produk:</label>
        <input type="text" value="{{ product.title }}" readonly class="border rounded px-3 py-2 w-full mb-3">

        <label class="font-semibold">Jumlah:</label>
        <input type="number" value="{{ quantity }}" readonly class="border rounded px-3 py-2 w-full mb-3">

        <label class="font-semibold">Alamat Pengiriman:</label>
        <textarea name="address" placeholder="Masukkan alamat lengkap" required class="border rounded px-3 py-2 w-full mb-3"></textarea>

        <label class="font-semibold">Metode Pembayaran:</label>
        <select name="payment_method" class="border rounded px-3 py-2 w-full mb-3">
            <option value="COD">Cash on Delivery</option>
            <option value="TRANSFER">Transfer Bank</option>
            <option value="EWALLET" selected>E-Wallet</option>
        </select>

        <label class="font-semibold">Jenis Pengiriman:</label>
        <select name="shipping_type" id="shippingType" class="border rounded px-3 py-2 w-full mb-3">
            <option value="BIASA">Biasa (Gratis)</option>
            <option value="CEPAT">Cepat (+Rp10.000)</option>
            <option value="SAMEDAY">Same Day (+Rp20.000)</option>
        </select>

        <div class="flex justify-between items-center border border-gray-300 rounded p-3 bg-gray-50 mb-3">
            <span>Tambahkan Asuransi Barang (+Rp5.000)</span>
            <input type="checkbox" id="insurance" name="insurance" class="w-5 h-5">
        </div>

        <label class="font-semibold">Catatan Tambahan:</label>
        <textarea name="note" placeholder="Contoh: tolong bungkus rapi" class="border rounded px-3 py-2 w-full mb-3"></textarea>

        <label class="font-semibold">Total Harga:</label>
        <input type="text" name="total_price" id="totalInput" value="Rp{{ total_price|floatformat:0 }}" readonly class="border rounded px-3 py-2 w-full mb-3">

        <div id="priceDisplay" class="text-right text-blue-600 font-semibold mb-4">
            Total: Rp{{ total_price|floatformat:0 }}
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold transition">
            Bayar Sekarang
        </button>
    </form>
  </div>
</div>

<script>
    const baseTotal = parseFloat("{{ total_price }}");
    const insuranceCheckbox = document.getElementById("insurance");
    const shippingSelect = document.getElementById("shippingType");
    const totalInput = document.getElementById("totalInput");
    const totalDisplay = document.getElementById("priceDisplay");

    function formatRupiah(num) {
        return "Rp" + num.toLocaleString("id-ID");
    }

    function updateTotal() {
        let finalTotal = baseTotal;
        const shipping = shippingSelect.value;

        if (shipping === "CEPAT") finalTotal += 10000;
        if (shipping === "SAMEDAY") finalTotal += 20000;
        if (insuranceCheckbox.checked) finalTotal += 5000;

        totalInput.value = formatRupiah(finalTotal);
        totalDisplay.textContent = `Total: ${formatRupiah(finalTotal)}`;
    }

    insuranceCheckbox.addEventListener("change", updateTotal);
    shippingSelect.addEventListener("change", updateTotal);

    const form = document.getElementById("checkoutForm");
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch("", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "success") {
                window.location.href = `/checkout/success/`;
            } else {
                alert(data.message || "Checkout gagal!");
            }
        })
        .catch(err => console.error("Error:", err));
    });
</script>
{% endblock content %}